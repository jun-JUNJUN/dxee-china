# Requirements Document

## Project Overview
test_deepseek_advanced_web_research3_07.pyを改造し、Web検索による事実収集と関連性評価に基づく回答集計・要約機能を追加する。

## Project Description (User Input)
test_deepseek_advanced_web_research3_07.py  を改造したいです。 質問に対して、Web検索をしてFactを集め、質問に対して7/10(70%) 以上が関連性がある回答が出たら、回答を集計して、一番関連性の高い答えを、Summaryしてください。最後に、Summaryを表示してください。

## Requirements

### 要求1: 関連性評価システムの強化
**ユーザーストーリー:** システム管理者として、Web検索結果の関連性を正確に評価し、70%以上の関連性がある回答のみを集計したい。

#### 受け入れ基準
1. WHEN 質問に対してWeb検索を実行したとき THEN 各検索結果に対して0-10の関連性スコアが算出される
2. WHEN 関連性スコアが計算されたとき THEN スコアが7/10（70%）以上の結果のみが集計対象となる
3. IF 70%以上の関連性がある回答が存在しないとき THEN 追加の検索クエリを生成し再検索を実行する
4. WHEN 関連性評価が完了したとき THEN 評価理由とスコアの詳細がログに記録される

### 要求2: 高関連性回答の自動集計機能
**ユーザーストーリー:** 研究者として、70%以上の関連性がある複数の回答を自動的に集計し、最も関連性の高い情報を取得したい。

#### 受け入れ基準
1. WHEN 70%以上の関連性スコアを持つ回答が複数存在するとき THEN これらの回答が自動的に集計される
2. WHEN 回答を集計するとき THEN 情報の重複を除去し、情報源URLを保持する
3. WHEN 集計が完了したとき THEN 関連性スコアの高い順に回答がランキングされる
4. IF 集計対象の回答が0個のとき THEN エラーメッセージを表示し、検索条件の見直しを提案する

### 要求3: 最高関連性回答の要約生成
**ユーザーストーリー:** エンドユーザーとして、集計された回答の中から最も関連性の高い答えの要約を自動生成し、理解しやすい形で確認したい。

#### 受け入れ基準
1. WHEN 集計された回答が存在するとき THEN 最も関連性スコアの高い回答が選択される
2. WHEN 最高関連性回答が選択されたとき THEN DeepSeek APIを使用して簡潔な要約が生成される
3. WHEN 要約を生成するとき THEN 元の質問との関連性を明確に示す
4. WHEN 要約が完成したとき THEN 情報源のURLと信頼性情報が含まれる

### 要求4: 要約結果の表示システム
**ユーザーストーリー:** ユーザーとして、生成された要約を分かりやすい形式で確認し、詳細情報にもアクセスできるようにしたい。

#### 受け入れ基準
1. WHEN 要約が生成されたとき THEN 構造化された文章と表で表示される
2. WHEN 要約を表示するとき THEN 関連性スコア、情報源URL、信頼性評価が併記される
3. IF 要約生成に失敗したとき THEN 代替情報として生データの一覧を表示する

### 要求5: 既存機能との統合
**ユーザーストーリー:** 開発者として、既存のtest_deepseek_advanced_web_research3_07.pyの機能を維持しながら、新しい関連性評価・集計機能を統合したい。

#### 受け入れ基準
1. WHEN 新機能を追加したとき THEN 既存のMongoDBキャッシュ機能が正常に動作する
2. WHEN 新機能を実行するとき THEN 既存の時間制限（10分）とトークン制限が適用される
3. WHEN 統合テストを行うとき THEN 既存のAPI（DeepSeek、Bright Data）との互換性が保たれる
4. IF 新機能でエラーが発生したとき THEN 既存の統計サマリー生成機能にフォールバックする

### 要求6: パフォーマンス最適化
**ユーザーストーリー:** システム管理者として、関連性評価と集計処理が既存のパフォーマンス基準内で動作することを確認したい。

#### 受け入れ基準
1. WHEN 関連性評価を実行するとき THEN 1つの検索結果につき平均3秒以内で処理が完了する
2. WHEN 回答集計を実行するとき THEN 最大50件の検索結果を30秒以内で処理できる
3. WHEN 要約生成を実行するとき THEN DeepSeek API呼び出しが1分以内で完了する
4. IF パフォーマンス基準を超えたとき THEN タイムアウト処理と部分結果の返却を行う
