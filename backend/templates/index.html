<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dxee Chat</title>
    <!-- Include marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- Include highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #222222;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            padding: 15px 0;
            text-align: center;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 100px;
            transition: margin-left 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        
        .welcome-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            margin: 100px 0 300px 0; /* Increased bottom margin to make room for fixed search form */
        }
        
        .welcome-message {
            font-size: 32px;
            color: #e0e0e0;
            margin-bottom: 30px;
        }
        
        .welcome-icon {
            color: #ff9776;
            margin-right: 10px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 90%;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 300px; /* Increased to make room for fixed search form */
            min-height: 300px;
        }
        
        .message {
            margin-bottom: 25px;
            padding: 0;
            width: 845px;
            max-width: 90%;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .message-icon {
            margin-right: 8px;
            color: #888;
        }
        
        .ai-icon {
            color: #ff9776;
        }
        
        .message-content {
            margin-left: 25px;
        }
        
        .user-message {
            align-self: flex-start;
            color: #e0e0e0;
        }
        
        .ai-message {
            align-self: flex-start;
            color: #e0e0e0;
        }
        
        .search-results {
            margin-top: 15px;
            margin-left: 25px;
            border-left: 2px solid #444;
            padding-left: 15px;
        }
        
        .message-form {
            position: relative;
            margin: 0 auto;
            width: 90%;
            max-width: 1000px;
            justify-content: center;
            margin-bottom: 20px; /* Add margin to prevent cut-off */
        }
        
        .message-input {
            width: calc(100% - 40px); /* Adjust width to account for padding */
            padding: 18px 50px 18px 20px;
            font-size: 16px;
            border: 1px solid #444;
            border-radius: 8px;
            outline: none;
            min-height: 24px; /* Single line initially but expands */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            resize: none; /* Prevent textarea resizing */
            background-color: #333;
            color: #e0e0e0;
            line-height: 1.5;
        }
        
        .send-button {
            position: absolute;
            bottom: 12px;
            right: 15px;
            padding: 8px;
            background-color: transparent;
            color: #999;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.3s, background-color 0.3s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover {
            color: #fff;
            background-color: #444;
        }
        
        .result-item {
            background-color: #333;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
        }
        
        .result-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #e0e0e0;
        }
        
        .result-content {
            color: #bbb;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            opacity: 0.7;
        }
        
        .error-message {
            color: #ff6b6b;
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
        }
        
        .search-frame {
            border: 1px solid #fff;
            border-radius: 16px;
            background: #181a1b;
            width: 864px;
            max-width: 90%;
            margin: 0 auto;
            padding: 32px 24px 24px 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
        .search-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
        }
        .left-buttons {
            display: flex;
            gap: 16px;
        }
        .right-button {
            display: flex;
            flex: 1;
            justify-content: flex-end;
        }
        .execute-btn {
            padding: 6px 14px;
            border-radius: 16px;
            border: 1px solid #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: #232526;
            color: #fff;
            transition: background 0.2s, border-color 0.2s;
        }
        .execute-btn:hover {
            background: #333;
            border-color: #00bcd4;
        }
        .search-btn, .deep-btn, .qwen-btn {
            padding: 6px 14px;
            border-radius: 16px;
            border: 1px solid #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: #232526;
            color: #fff;
            transition: background 0.2s, border-color 0.2s, opacity 0.2s;
        }
        .search-btn {
            border-color: #00bcd4;
        }
        .search-btn:hover, .deep-btn:hover, .qwen-btn:hover {
            background: #333;
            border-color: #00bcd4;
        }
        .search-btn.selected, .deep-btn.selected, .qwen-btn.selected {
            background: #00bcd4;
            color: #fff;
            border-color: #00bcd4;
        }
        .search-btn.disabled, .deep-btn.disabled, .qwen-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #232526;
            border-color: #666;
        }
        .search-btn.disabled:hover, .deep-btn.disabled:hover, .qwen-btn.disabled:hover {
            background: #232526;
            border-color: #666;
        }
        
        /* Markdown formatting styles */
        .message-content h1, .message-content h2, .message-content h3,
        .message-content h4, .message-content h5, .message-content h6 {
            color: #f0f0f0;
            margin: 16px 0 8px 0;
            font-weight: 600;
        }
        
        .message-content h1 { font-size: 1.8em; border-bottom: 2px solid #444; padding-bottom: 8px; }
        .message-content h2 { font-size: 1.5em; border-bottom: 1px solid #444; padding-bottom: 6px; }
        .message-content h3 { font-size: 1.3em; }
        .message-content h4 { font-size: 1.1em; }
        .message-content h5 { font-size: 1em; }
        .message-content h6 { font-size: 0.9em; }
        
        .message-content strong, .message-content b {
            color: #fff;
            font-weight: 600;
        }
        
        .message-content em, .message-content i {
            color: #f0f0f0;
            font-style: italic;
        }
        
        .message-content code {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .message-content pre {
            background-color: #1e1e1e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            overflow-x: auto;
            line-height: 1.4;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            color: inherit;
        }
        
        .message-content ul, .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .message-content li {
            margin: 6px 0;
            line-height: 1.5;
        }
        
        .message-content ul li {
            list-style-type: disc;
        }
        
        .message-content ol li {
            list-style-type: decimal;
        }
        
        .message-content blockquote {
            border-left: 4px solid #ff9776;
            margin: 12px 0;
            padding: 8px 16px;
            background-color: rgba(255, 151, 118, 0.1);
            font-style: italic;
        }
        
        .message-content a {
            color: #00bcd4;
            text-decoration: none;
        }
        
        .message-content a:hover {
            color: #26c6da;
            text-decoration: underline;
        }
        
        .message-content hr {
            border: none;
            border-top: 1px solid #444;
            margin: 20px 0;
        }
        
        .message-content p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }
        
        .message-content th, .message-content td {
            border: 1px solid #444;
            padding: 8px 12px;
            text-align: left;
        }
        
        .message-content th {
            background-color: #333;
            font-weight: 600;
        }
        
        .message-content del {
            color: #888;
            text-decoration: line-through;
        }
        
        /* Ensure proper spacing for formatted content */
        .message-content.formatted {
            line-height: 1.6;
        }
        
        .message-content.formatted > *:first-child {
            margin-top: 0;
        }
        
        .message-content.formatted > *:last-child {
            margin-bottom: 0;
        }
        
        .qwen-btn {
            padding: 6px 14px;
            border-radius: 16px;
            border: 1px solid #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: #232526;
            color: #fff;
            transition: background 0.2s, border-color 0.2s, opacity 0.2s;
        }
        
        .qwen-btn:hover {
            background: #333;
            border-color: #00bcd4;
        }
        
        .qwen-btn.selected {
            background: #00bcd4;
            color: #fff;
            border-color: #00bcd4;
        }
        
        .qwen-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #232526;
            border-color: #666;
        }
        
        .qwen-btn.disabled:hover {
            background: #232526;
            border-color: #666;
        }
        /* Floating Auth Panels */
        .auth-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2000;
            width: 340px;
            background: #232526;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.25);
            border: 1px solid #444;
            padding: 32px 24px 24px 24px;
            display: none;
            flex-direction: column;
            align-items: center;
            color: #e0e0e0;
        }
        .auth-panel.active {
            display: flex;
        }
        .auth-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 18px;
            color: #fff;
        }
        .auth-google-btn {
            width: 100%;
            margin-bottom: 18px;
            display: flex;
            justify-content: center;
        }
        .auth-switch-link {
            color: #00bcd4;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.95em;
            margin-top: 8px;
        }
        .auth-separator {
            width: 100%;
            border-bottom: 1px solid #444;
            margin: 18px 0 12px 0;
        }
        .auth-provider-btn {
            background: #181a1b;
            border: 1px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-weight: 500;
            padding: 10px 0;
            transition: background 0.2s, border-color 0.2s;
        }
        .auth-provider-btn:not(.disabled):hover {
            background: #333;
            border-color: #00bcd4;
        }
        .auth-provider-btn.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Sidebar styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 100px;
            background: #181a1b;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: width 0.3s cubic-bezier(0.4,0,0.2,1);
            z-index: 2001;
            box-shadow: 2px 0 8px rgba(0,0,0,0.08);
        }
        .sidebar.closed {
            width: 40px;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 10px 8px 0 8px;
        }
        .sidebar-toggle-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            outline: none;
        }
        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            padding: 20px 8px;
            overflow-y: auto;
        }
        .sidebar.closed .sidebar-content {
            display: none;
        }
        .chat-history-section {
            flex: 1;
            overflow-y: auto;
        }
        .chat-history-header {
            font-size: 12px;
            font-weight: 600;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            text-align: center;
        }
        .chat-history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .chat-history-item {
            margin-bottom: 8px;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 6px;
            background: #232526;
            border: 1px solid #333;
            transition: all 0.2s ease;
        }
        .chat-history-item:hover {
            background: #2a2d2e;
            border-color: #00bcd4;
        }
        .chat-history-item.active {
            background: #00bcd4;
            border-color: #00bcd4;
            color: #000;
        }
        .chat-history-item-title {
            font-size: 11px;
            font-weight: 500;
            color: #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }
        .chat-history-item.active .chat-history-item-title {
            color: #000;
        }
        .chat-history-item-date {
            font-size: 9px;
            color: #888;
            margin-top: 2px;
        }
        .chat-history-item.active .chat-history-item-date {
            color: #333;
        }
        .chat-history-loading {
            text-align: center;
            color: #888;
            font-size: 11px;
            padding: 20px 10px;
        }
        .sidebar-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 20px;
        }
        .personal-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #232526;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 8px;
            border: 1px solid #333;
        }
        .personal-panel {
            position: fixed;
            left: 110px;
            bottom: 30px;
            background: #232526;
            color: #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 18px 24px 12px 24px;
            min-width: 160px;
            display: none;
            z-index: 2100;
            border: 1px solid #444;
        }
        .personal-panel.open {
            display: block;
        }
        .logout-btn {
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        .logout-btn:hover {
            background: #b52a37;
        }
        /* New Chat Button */
        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            background: #ff9776;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            padding: 12px 8px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: background 0.2s, transform 0.1s;
        }
        .new-chat-btn:hover {
            background: #ff8759;
            transform: translateY(-1px);
        }
        .new-chat-btn:active {
            transform: translateY(0);
        }
        .new-chat-icon {
            font-size: 18px;
            margin-right: 6px;
        }
        .new-chat-text {
            font-size: 14px;
        }
        /* Chat History Container */
        .chat-history-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            flex: 1;
        }
        .chat-history-header {
            font-size: 12px;
            font-weight: 600;
            color: #b8c5d6;
            margin-bottom: 10px;
            padding: 0 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chat-history-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .chat-history-item {
            background: #232526;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px 8px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            width: 100%;
            box-sizing: border-box;
        }
        .chat-history-item:hover {
            background: #2a2d2e;
            border-color: #444;
        }
        .chat-history-item.active {
            background: #ff9776;
            border-color: #ff9776;
        }
        .chat-history-item.active:hover {
            background: #ff8759;
            border-color: #ff8759;
        }
        .chat-history-item-text {
            font-size: 12px;
            color: #e0e0e0;
            line-height: 1.3;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .chat-history-item.active .chat-history-item-text {
            color: #fff;
        }
        /* Sidebar responsiveness for new elements */
        .sidebar.closed .new-chat-text,
        .sidebar.closed .chat-history-header,
        .sidebar.closed .chat-history-item-text {
            display: none;
        }
        .sidebar.closed .new-chat-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            padding: 0;
            margin-bottom: 12px;
        }
        .sidebar.closed .new-chat-icon {
            margin-right: 0;
            font-size: 16px;
        }
        .sidebar.closed .chat-history-item {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar.closed .chat-history-item-text {
            display: none;
        }
        /* Adjust main container for sidebar */
        .sidebar.closed ~ .container {
            margin-left: 40px;
        }
        @media (max-width: 600px) {
            .sidebar { width: 60px; }
            .sidebar.closed { width: 32px; }
            .container { margin-left: 60px; }
            .sidebar.closed ~ .container { margin-left: 32px; }
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        .verification-form {
            display: none;
        }
        .verification-form.active {
            display: block;
        }
        .auth-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #181a1b;
            color: #e0e0e0;
            margin-bottom: 12px;
            box-sizing: border-box; /* Ensures padding doesn't affect width */
        }
        .auth-notification {
            display: none;
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            font-size: 0.9em;
            border-radius: 8px;
            text-align: center;
        }
        .alert-danger {
            background-color: #dc354520;
            border: 1px solid #dc3545;
            color: #f8d7da;
        }
        .alert-success {
            background-color: #28a74520;
            border: 1px solid #28a745;
            color: #d4edda;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div>
            <div class="sidebar-header">
                <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="Close sidebar">&#x25C0;</button>
            </div>
            <div class="sidebar-content">
                <button class="new-chat-btn" id="newChatBtn" title="Start new chat">
                    <span class="new-chat-icon">+</span>
                    <span class="new-chat-text">New Chat</span>
                </button>
                <div class="chat-history-section">
                    <div class="chat-history-header">Recent Chats</div>
                    <div id="chat-history-loading" class="chat-history-loading">Loading...</div>
                    <ul id="chatHistoryList" class="chat-history-list" style="display: none;"></ul>
                </div>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="personal-icon" id="personalIcon" title="Personal panel">
                <span>&#128100;</span>
            </div>
        </div>
    </div>
    <div class="personal-panel" id="personalPanel">
        <div style="font-weight: bold; margin-bottom: 8px;">Personal Panel</div>
        <div id="personalSessionInfo" style="margin-bottom: 12px; font-size: 0.98em; color: #b8c5d6;"></div>
        <div id="adminLinkContainer" style="margin-bottom: 12px; display: none;">
            <a href="/admin" target="_blank" style="color: #ff9776; text-decoration: none; font-size: 0.9em; display: flex; align-items: center; gap: 6px;">
                <span>⚙️</span>
                <span>Admin Dashboard</span>
            </a>
        </div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
    <div class="container">
        <div id="welcome-screen" class="welcome-container">
            <div class="search-frame">
                <form id="message-form" class="message-form">
                    <textarea id="message-input" class="message-input" placeholder="Type your question here..." required rows="1"></textarea>
                    <div class="search-buttons">
                        <div class="left-buttons">
                            <button type="button" class="search-btn selectable-btn" data-mode="search">Search</button>
                            <button type="button" class="deep-btn selectable-btn" data-mode="deep">Deep Search</button>
                            <button type="button" class="qwen-btn selectable-btn" data-mode="googleweb">Google Deep</button>
                        </div>
                        <div class="right-button">
                            <button type="button" class="execute-btn">Execute</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="chat-screen" class="chat-container hidden">
            <div id="chat-messages" class="chat-messages">
                <!-- Messages will be dynamically added here -->
            </div>
            
            <div class="search-frame">
                <form id="chat-form" class="message-form">
                    <textarea id="chat-input" class="message-input" placeholder="Type your question here..." required rows="1"></textarea>
                    <div class="search-buttons">
                        <div class="left-buttons">
                            <button type="button" class="search-btn selectable-btn selected" data-mode="search">Search</button>
                            <button type="button" class="deep-btn selectable-btn" data-mode="deep">Deep Search</button>
                            <button type="button" class="qwen-btn selectable-btn" data-mode="googleweb">Google Deep</button>
                        </div>
                        <div class="right-button">
                            <button type="button" class="execute-btn" id="chat-execute-btn">Execute</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Floating Login Panel -->
    <div id="login-panel" class="auth-panel">
        <div class="auth-title">Sign in to Dxee Chat</div>
        <div class="auth-google-btn">
            <div id="google-login-btn"></div>
        </div>
        <button class="auth-provider-btn" id="github-login-btn" style="display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-top: 12px;">
            <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg" alt="GitHub" style="width: 22px; height: 22px;"> Sign in with GitHub
        </button>
        <div class="auth-separator"></div>
        <form id="email-login-form" style="width: 100%;">
            <input type="email" id="login-email" class="auth-input" placeholder="Email" required>
            <input type="password" id="login-password" class="auth-input" placeholder="Password" required>
            <button type="submit" class="auth-provider-btn" style="width: 100%;">Sign in with Email</button>
        </form>
        <div style="text-align: center; margin-top: 10px;">
            <span class="auth-switch-link" id="forgot-password-link" style="font-size: 0.9em;">Forgot Password?</span>
        </div>
        <div id="auth-notification-login" class="auth-notification alert-danger" role="alert"></div>
        <div class="auth-separator"></div>
        <div>Don't have an account? <span class="auth-switch-link" id="to-register-link">Register</span></div>
    </div>
    <!-- Floating Registration Panel -->
    <div id="register-panel" class="auth-panel">
        <div class="auth-title">Register for Dxee Chat</div>
         <div class="auth-google-btn">
            <div id="google-register-btn"></div>
        </div>
        <button class="auth-provider-btn" id="github-register-btn" style="display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-top: 12px;">
            <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg" alt="GitHub" style="width: 22px; height: 22px;"> Register with GitHub
        </button>
        <div class="auth-separator"></div>
        <form id="email-register-form" style="width: 100%;">
            <input type="email" id="register-email" class="auth-input" placeholder="Email" required>
            <input type="password" id="register-password" class="auth-input" placeholder="Password" required>
            <button type="submit" class="auth-provider-btn" style="width: 100%;">Register with Email</button>
        </form>
        <div id="auth-notification-register" class="auth-notification" role="alert"></div>
        <div class="auth-separator"></div>
        <div>Already have an account? <span class="auth-switch-link" id="to-login-link-from-register">Login</span></div>
    </div>

    <!-- Floating Verification Panel -->
    <div id="verification-panel" class="auth-panel">
        <div class="auth-title">Verify Your Email</div>
        <p style="font-size: 0.95em; text-align: center; margin-bottom: 18px;">We've sent a 6-digit code to <strong id="verification-email-display"></strong>. Please enter it below.</p>
        <form id="verify-form" style="width: 100%;">
            <input type="text" id="verification-code" class="auth-input" placeholder="6-digit code" required maxlength="6" style="text-align: center; font-size: 1.2em; letter-spacing: 5px;">
            <button type="submit" class="auth-provider-btn" style="width: 100%;">Verify and Sign In</button>
        </form>
        <div id="auth-notification-verify" class="auth-notification" role="alert"></div>
        <div style="margin-top: 15px; font-size: 0.9em;">Didn't receive the code? <span id="resend-verification-code" class="auth-switch-link">Resend</span></div>
    </div>

    <!-- Floating Forgot Password Panel -->
    <div id="forgot-password-panel" class="auth-panel">
        <div class="auth-title">Reset Password</div>
        <p style="font-size: 0.95em; text-align: center; margin-bottom: 18px;">Enter your email address and we'll send you a link to reset your password.</p>
        <form id="forgot-password-form" style="width: 100%;">
            <input type="email" id="forgot-password-email" class="auth-input" placeholder="Email address" required>
            <button type="submit" class="auth-provider-btn" style="width: 100%;">Send Reset Link</button>
        </form>
        <div id="auth-notification-forgot" class="auth-notification" role="alert"></div>
        <div id="forgot-password-success" class="auth-notification alert-success" role="alert" style="display: none;">
            If an account with this email exists, you will receive a password reset link.
        </div>
        <div style="margin-top: 15px; font-size: 0.9em;">Remember your password? <span id="back-to-login-link" class="auth-switch-link">Back to Login</span></div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const welcomeScreen = document.getElementById('welcome-screen');
            const chatScreen = document.getElementById('chat-screen');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const chatMessages = document.getElementById('chat-messages');
            
            // Auto-resize textarea as user types
            function setupTextareaResize(textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
            
            setupTextareaResize(messageInput);
            
            // Track current chat session and search mode
            let currentChatId = null;
            let currentSearchMode = 'search'; // Default to 'search' mode
            
            // Function to send message to the backend API
            async function sendMessage(message, chatId = null, searchMode = 'search') {
                try {
                    console.log(`Sending message to backend: ${message.substring(0, 30)}... with chatId: ${chatId}, mode: ${searchMode}`);
                    const response = await fetch('/chat/message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            chat_id: chatId,
                            search_mode: searchMode
                        }),
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Server error (${response.status}): ${errorText}`);
                        throw new Error(`Server responded with ${response.status}: ${errorText}`);
                    }
                    
                    const result = await response.json();
                    console.log('Response received:', result);
                    return result;
                } catch (error) {
                    console.error('Error sending message:', error);
                    return null;
                }
            }
            
            // Function to get chat history
            async function getChatHistory(chatId) {
                try {
                    const response = await fetch(`/chat/history/${chatId}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error getting chat history:', error);
                    return null;
                }
            }

            // Function to load user's chat list
            async function loadUserChats() {
                try {
                    const response = await fetch('/chat/user?limit=10');
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const data = await response.json();
                    return data.chats || [];
                } catch (error) {
                    console.error('Error loading user chats:', error);
                    return [];
                }
            }

            // Function to display chat history in sidebar
            async function displayChatHistory() {
                const chatHistoryList = document.getElementById('chatHistoryList');
                
                if (!chatHistoryList) {
                    console.error('Chat history list element not found');
                    return;
                }

                try {
                    const chats = await loadUserChats();
                    
                    // Clear existing chat history
                    chatHistoryList.innerHTML = '';
                    
                    if (chats.length === 0) {
                        chatHistoryList.innerHTML = '<div style="color: #888; font-size: 11px; text-align: center; padding: 10px;">No chats yet</div>';
                        return;
                    }
                    
                    // Create chat history items
                    chats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-history-item';
                        chatItem.dataset.chatId = chat.chat_id;
                        
                        // Check if this is the active chat
                        if (chat.chat_id === currentChatId) {
                            chatItem.classList.add('active');
                        }
                        
                        const chatText = document.createElement('div');
                        chatText.className = 'chat-history-item-text';
                        
                        // Get the first message content and truncate to 30 characters
                        let displayText = 'New Chat';
                        if (chat.messages && chat.messages.length > 0) {
                            const firstMessage = chat.messages.find(msg => msg.sender === 'user');
                            if (firstMessage && firstMessage.content) {
                                displayText = firstMessage.content.substring(0, 30);
                                if (firstMessage.content.length > 30) {
                                    displayText += '...';
                                }
                            }
                        }
                        
                        chatText.textContent = displayText;
                        chatItem.appendChild(chatText);
                        
                        // Add click handler
                        chatItem.addEventListener('click', () => {
                            switchToChat(chat.chat_id);
                        });
                        
                        chatHistoryList.appendChild(chatItem);
                    });
                    
                } catch (error) {
                    console.error('Error displaying chat history:', error);
                    chatHistoryList.innerHTML = '<div style="color: #ff6b6b; font-size: 11px; text-align: center; padding: 10px;">Error loading chats</div>';
                }
            }

            // Function to switch to a specific chat
            async function switchToChat(chatId) {
                try {
                    // Update current chat ID
                    currentChatId = chatId;
                    
                    // Update active state in sidebar
                    const chatItems = document.querySelectorAll('.chat-history-item');
                    chatItems.forEach(item => {
                        if (item.dataset.chatId === chatId) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });
                    
                    // Clear current chat messages
                    chatMessages.innerHTML = '';
                    
                    // Show chat screen if not already shown
                    welcomeScreen.classList.add('hidden');
                    chatScreen.classList.remove('hidden');
                    
                    // Load and display chat history
                    const chatData = await getChatHistory(chatId);
                    if (chatData && chatData.messages) {
                        chatData.messages.forEach(msg => {
                            if (msg.type === 'user') {
                                addUserMessage(msg.message);
                            } else if (msg.type === 'assistant') {
                                addAIMessage(msg.message, msg.search_results || []);
                            }
                        });
                        
                        // Scroll to bottom
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    
                } catch (error) {
                    console.error('Error switching to chat:', error);
                }
            }

            // Function to start a new chat
            function startNewChat() {
                // Clear current chat ID
                currentChatId = null;
                
                // Clear active state from all chat items
                const chatItems = document.querySelectorAll('.chat-history-item');
                chatItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                // Clear chat messages
                chatMessages.innerHTML = '';
                
                // Show welcome screen
                welcomeScreen.classList.remove('hidden');
                chatScreen.classList.add('hidden');
                
                // Reset search mode to default
                currentSearchMode = 'search';
                
                // Update search mode buttons in welcome screen
                const welcomeButtons = document.querySelectorAll('#welcome-screen .selectable-btn');
                welcomeButtons.forEach(btn => {
                    btn.classList.remove('selected', 'disabled');
                    if (btn.dataset.mode === 'search') {
                        btn.classList.add('selected');
                    }
                });
            }
            
            // Function to create a search form
            function createSearchForm() {
                const searchFrame = document.createElement('div');
                searchFrame.className = 'search-frame';
                
                const form = document.createElement('form');
                form.className = 'message-form';
                
                const textarea = document.createElement('textarea');
                textarea.className = 'message-input';
                textarea.placeholder = 'Type your question here...';
                textarea.required = true;
                textarea.rows = 1;
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'search-buttons';
                
                const leftButtons = document.createElement('div');
                leftButtons.className = 'left-buttons';
                
                const searchBtn = document.createElement('button');
                searchBtn.type = 'button';
                searchBtn.className = 'search-btn selectable-btn selected';
                searchBtn.dataset.mode = 'search';
                searchBtn.textContent = 'Search';
                
                const deepBtn = document.createElement('button');
                deepBtn.type = 'button';
                deepBtn.className = 'deep-btn selectable-btn';
                deepBtn.dataset.mode = 'deep';
                deepBtn.textContent = 'Deep Search';
                
                const qwenBtn = document.createElement('button');
                qwenBtn.type = 'button';
                qwenBtn.className = 'qwen-btn selectable-btn';
                qwenBtn.dataset.mode = 'googleweb';
                qwenBtn.textContent = 'Google Deep';
                
                const rightButton = document.createElement('div');
                rightButton.className = 'right-button';
                
                const executeBtn = document.createElement('button');
                executeBtn.type = 'button';
                executeBtn.className = 'execute-btn';
                executeBtn.textContent = 'Execute';
                
                leftButtons.appendChild(searchBtn);
                leftButtons.appendChild(deepBtn);
                leftButtons.appendChild(qwenBtn);
                
                rightButton.appendChild(executeBtn);
                
                buttonsDiv.appendChild(leftButtons);
                buttonsDiv.appendChild(rightButton);
                
                form.appendChild(textarea);
                form.appendChild(buttonsDiv);
                
                searchFrame.appendChild(form);
                
                // Add event listeners for mode selection
                const selectableBtns = form.querySelectorAll('.selectable-btn');
                selectableBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Don't allow clicking disabled buttons
                        if (this.classList.contains('disabled')) {
                            return;
                        }
                        
                        // Remove selected and disabled classes from all buttons
                        selectableBtns.forEach(b => {
                            b.classList.remove('selected', 'disabled');
                        });
                        
                        // Add selected class to clicked button
                        this.classList.add('selected');
                        
                        // Update current search mode
                        currentSearchMode = this.dataset.mode;
                        console.log('Search mode changed to:', currentSearchMode);
                        
                        // Handle Deep Search mode - disable other buttons
                        if (currentSearchMode === 'deep') {
                            selectableBtns.forEach(b => {
                                if (b.dataset.mode !== 'deep') {
                                    b.classList.add('disabled');
                                }
                            });
                        }
                    });
                });
                
                executeBtn.addEventListener('click', function() {
                    form.requestSubmit();
                });
                
                textarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.shiftKey) {
                        e.preventDefault();
                        form.requestSubmit();
                    }
                });
                
                setupTextareaResize(textarea);
                
                // Add form submit event
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const searchText = textarea.value.trim();
                    if (!searchText) return;
                    
                    // Make sure we're in the chat screen
                    welcomeScreen.classList.add('hidden');
                    chatScreen.classList.remove('hidden');
                    
                    // Display the search query
                    displaySearchQuery(searchText);
                    
                    // Create a loading indicator in the AI answer area
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'message ai-message';
                    loadingDiv.id = 'loading-message';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'message-header';
                    
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'message-icon ai-icon';
                    iconSpan.textContent = '✨';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = 'AI';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    contentDiv.textContent = 'Searching...';
                    
                    headerDiv.appendChild(iconSpan);
                    headerDiv.appendChild(nameSpan);
                    loadingDiv.appendChild(headerDiv);
                    loadingDiv.appendChild(contentDiv);
                    
                    chatMessages.appendChild(loadingDiv);
                    
                    // Scroll to the bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Clear the current form
                    textarea.value = '';
                    textarea.style.height = 'auto';
                    
                    // Process the search asynchronously
                    sendMessage(searchText, currentChatId, currentSearchMode).then(result => {
                        if (result) {
                            currentChatId = result.chat_id;
                            
                            // Remove loading indicator
                            const loadingMessage = document.getElementById('loading-message');
                            if (loadingMessage) {
                                loadingMessage.remove();
                            }
                            
                            // Display the search result
                            displaySearchResult(result.response);
                            
                            // Scroll to the bottom
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }).catch(error => {
                        console.error('Error processing search:', error);
                        
                        // Remove loading indicator
                        const loadingMessage = document.getElementById('loading-message');
                        if (loadingMessage) {
                            loadingMessage.remove();
                        }
                        
                        // Display error message
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'message ai-message error-message';
                        errorDiv.textContent = 'Error processing your search. Please try again.';
                        chatMessages.appendChild(errorDiv);
                        
                        // Scroll to the bottom
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });
                });
                
                return searchFrame;
            }
            
            // Function to display search query
            function displaySearchQuery(query) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user-message';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon';
                iconSpan.textContent = 'You';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = query;
                
                headerDiv.appendChild(iconSpan);
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                
                chatMessages.appendChild(messageDiv);
            }
            
            // Function to display search result
            function displaySearchResult(response) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.style.width = '845px'; // Fixed width to match loading indicator
                messageDiv.style.maxWidth = '90%'; // Responsive for smaller screens
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon ai-icon';
                iconSpan.textContent = '✨';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'AI';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = response.message;
                
                headerDiv.appendChild(iconSpan);
                headerDiv.appendChild(nameSpan);
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                
                // Add search results if available
                if (response.search_results && response.search_results.length > 0) {
                    const resultsDiv = document.createElement('div');
                    resultsDiv.className = 'search-results';
                    
                    response.search_results.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'result-title';
                        titleDiv.textContent = result.title || 'Untitled';
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'result-content';
                        contentDiv.textContent = result.content || result.snippet || '';
                        
                        resultItem.appendChild(titleDiv);
                        resultItem.appendChild(contentDiv);
                        resultsDiv.appendChild(resultItem);
                    });
                    
                    messageDiv.appendChild(resultsDiv);
                }
                
                chatMessages.appendChild(messageDiv);
                
                // Scroll to the bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Function to add user message to chat
            function addUserMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user-message';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon';
                iconSpan.textContent = 'You';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                // Format user messages as plain text (they are typically simple queries)
                contentDiv.textContent = message;
                
                headerDiv.appendChild(iconSpan);
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                
                chatMessages.appendChild(messageDiv);
            }
            
            // Function to add AI message to chat
            function addAIMessage(message, searchResults = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon ai-icon';
                iconSpan.textContent = '✨';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'AI';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                // Format AI messages using markdown parser, same as streaming messages
                try {
                    contentDiv.innerHTML = marked.parse(message);
                    contentDiv.classList.add('formatted');
                    
                    // Highlight code blocks
                    contentDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                } catch (e) {
                    console.warn('Failed to parse markdown, using plain text:', e);
                    contentDiv.textContent = message;
                }
                
                headerDiv.appendChild(iconSpan);
                headerDiv.appendChild(nameSpan);
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                
                // Add search results if available
                if (searchResults && searchResults.length > 0) {
                    const resultsDiv = document.createElement('div');
                    resultsDiv.className = 'search-results';
                    
                    searchResults.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'result-title';
                        titleDiv.textContent = result.title || 'Untitled';
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'result-content';
                        contentDiv.textContent = result.content || result.snippet || '';
                        
                        resultItem.appendChild(titleDiv);
                        resultItem.appendChild(contentDiv);
                        resultsDiv.appendChild(resultItem);
                    });
                    
                    messageDiv.appendChild(resultsDiv);
                }
                
                chatMessages.appendChild(messageDiv);
            }
            
            // Initialize the UI for the welcome screen form
            messageForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;
                
                // Switch from welcome screen to chat screen immediately
                welcomeScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                
                // Display the search query
                displaySearchQuery(message);
                
                // Create a loading indicator in the AI answer area
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message';
                loadingDiv.id = 'loading-message';
                loadingDiv.style.width = '845px'; // Fixed width to match results
                loadingDiv.style.maxWidth = '90%'; // Responsive for smaller screens
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon ai-icon';
                iconSpan.textContent = '✨';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'AI';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = 'Searching...';
                
                headerDiv.appendChild(iconSpan);
                headerDiv.appendChild(nameSpan);
                loadingDiv.appendChild(headerDiv);
                loadingDiv.appendChild(contentDiv);
                
                chatMessages.appendChild(loadingDiv);
                
                // Scroll to the bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Clear the input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Process the search - check if dual research mode
                if (currentSearchMode === 'googleweb') {
                    console.log('Using dual research mode for welcome screen');
                    await handleDualResearch(message);
                } else {
                    // Process the search with streaming
                    await displayStreamingResponse(message);
                }
            });
            
            // Initialize the UI for the chat screen form
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            
            // Setup textarea resize for chat input
            setupTextareaResize(chatInput);
            
            // Add event listener for chat form submission
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Display the search query
                displaySearchQuery(message);
                
                // Create a loading indicator in the AI answer area
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message';
                loadingDiv.id = 'loading-message';
                loadingDiv.style.width = '845px'; // Fixed width to match results
                loadingDiv.style.maxWidth = '90%'; // Responsive for smaller screens
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon ai-icon';
                iconSpan.textContent = '✨';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'AI';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = 'Searching...';
                
                headerDiv.appendChild(iconSpan);
                headerDiv.appendChild(nameSpan);
                loadingDiv.appendChild(headerDiv);
                loadingDiv.appendChild(contentDiv);
                
                chatMessages.appendChild(loadingDiv);
                
                // Scroll to the bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Clear the input
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                // Process the search - check if dual research mode
                if (currentSearchMode === 'googleweb') {
                    console.log('Using dual research mode for chat screen');
                    await handleDualResearch(message);
                } else {
                    // Process the search with streaming
                    await displayStreamingResponse(message);
                }
            });
            
            // Handle mode selection for welcome screen
            const welcomeSelectableBtns = document.querySelectorAll('#welcome-screen .selectable-btn');
            welcomeSelectableBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Don't allow clicking disabled buttons
                    if (this.classList.contains('disabled')) {
                        return;
                    }
                    
                    // Remove selected and disabled classes from all buttons in welcome screen
                    welcomeSelectableBtns.forEach(b => {
                        b.classList.remove('selected', 'disabled');
                    });
                    
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    
                    // Update current search mode
                    currentSearchMode = this.dataset.mode;
                    console.log('Welcome screen search mode changed to:', currentSearchMode);
                    
                    // Handle Deep Search mode - disable other buttons
                    if (currentSearchMode === 'deep') {
                        welcomeSelectableBtns.forEach(b => {
                            if (b.dataset.mode !== 'deep') {
                                b.classList.add('disabled');
                            }
                        });
                    }
                });
            });
            
            // Handle mode selection for chat screen
            const chatSelectableBtns = document.querySelectorAll('#chat-screen .selectable-btn');
            chatSelectableBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Don't allow clicking disabled buttons
                    if (this.classList.contains('disabled')) {
                        return;
                    }
                    
                    // Remove selected and disabled classes from all buttons in chat screen
                    chatSelectableBtns.forEach(b => {
                        b.classList.remove('selected', 'disabled');
                    });
                    
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    
                    // Update current search mode
                    currentSearchMode = this.dataset.mode;
                    console.log('Chat screen search mode changed to:', currentSearchMode);
                    
                    // Handle Deep Search mode - disable other buttons
                    if (currentSearchMode === 'deep') {
                        chatSelectableBtns.forEach(b => {
                            if (b.dataset.mode !== 'deep') {
                                b.classList.add('disabled');
                            }
                        });
                    }
                });
            });
            
            // Execute search (submit form) when Execute button is clicked on welcome screen
            const executeBtn = document.querySelector('.execute-btn');
            executeBtn.addEventListener('click', function() {
                messageForm.requestSubmit();
            });
            
            // Execute search when Execute button is clicked on chat screen
            const chatExecuteBtn = document.getElementById('chat-execute-btn');
            chatExecuteBtn.addEventListener('click', function() {
                chatForm.requestSubmit();
            });
            
            // Execute search when Shift+Enter is pressed in the welcome screen textarea
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.shiftKey) {
                    e.preventDefault();
                    messageForm.requestSubmit();
                }
            });
            
            // Execute search when Shift+Enter is pressed in the chat screen textarea
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.shiftKey) {
                    e.preventDefault();
                    chatForm.requestSubmit();
                }
            });
            
            // New Chat button event handler
            const newChatBtn = document.getElementById('newChatBtn');
            if (newChatBtn) {
                newChatBtn.addEventListener('click', function() {
                    console.log('New chat button clicked');
                    startNewChat();
                });
            }
            
            // Load chat history when page loads
            displayChatHistory();
            
            // Function to get recent chat history from DOM (up to 2 previous exchanges)
            function getRecentChatHistory(maxExchanges = 2) {
                const messages = chatMessages.querySelectorAll('.message');
                const history = [];
                let exchangeCount = 0;
                
                // Go through messages in reverse order to get most recent first
                for (let i = messages.length - 1; i >= 0 && exchangeCount < maxExchanges; i--) {
                    const message = messages[i];
                    
                    // Skip loading messages
                    if (message.id === 'loading-message') continue;
                    
                    const isUser = message.classList.contains('user-message');
                    const isAI = message.classList.contains('ai-message');
                    
                    if (isUser || isAI) {
                        const content = message.querySelector('.message-content');
                        if (content && content.textContent.trim()) {
                            history.unshift({
                                type: isUser ? 'user' : 'assistant',
                                content: content.textContent.trim()
                            });
                            
                            // Count complete exchanges (user + assistant pairs)
                            if (isUser && i > 0) {
                                const prevMessage = messages[i - 1];
                                if (prevMessage && prevMessage.classList.contains('ai-message')) {
                                    exchangeCount++;
                                }
                            }
                        }
                    }
                }
                
                // Ensure we have complete exchanges and limit to maxExchanges
                const completeHistory = [];
                let currentExchanges = 0;
                
                for (let i = 0; i < history.length - 1 && currentExchanges < maxExchanges; i += 2) {
                    if (history[i].type === 'user' && history[i + 1].type === 'assistant') {
                        completeHistory.push(history[i]);
                        completeHistory.push(history[i + 1]);
                        currentExchanges++;
                    }
                }
                
                return completeHistory;
            }
            
            // Function to handle streaming response
            async function displayStreamingResponse(message) {
                try {
                    // Get recent chat history from DOM
                    const chatHistory = getRecentChatHistory(2);
                    
                    const response = await fetch('/chat/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            chat_id: currentChatId,
                            chat_history: chatHistory,
                            search_mode: currentSearchMode
                        }),
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    // Create AI message container
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message ai-message';
                    messageDiv.style.width = '845px';
                    messageDiv.style.maxWidth = '90%';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'message-header';
                    
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'message-icon ai-icon';
                    iconSpan.textContent = '✨';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = 'AI';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    contentDiv.textContent = '';
                    
                    headerDiv.appendChild(iconSpan);
                    headerDiv.appendChild(nameSpan);
                    messageDiv.appendChild(headerDiv);
                    messageDiv.appendChild(contentDiv);
                    
                    // Remove loading message and add streaming message
                    const loadingMessage = document.getElementById('loading-message');
                    if (loadingMessage) {
                        loadingMessage.remove();
                    }
                    
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    let accumulatedContent = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            break;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.slice(6).trim();
                                    if (!jsonStr) continue; // Skip empty data lines
                                    const data = JSON.parse(jsonStr);
                                    
                                    if (data.type === 'chat_id') {
                                        // Only refresh chat history if this is a new chat (currentChatId was null)
                                        const isNewChat = currentChatId === null;
                                        currentChatId = data.chat_id;
                                        if (isNewChat) {
                                            // Refresh chat history when new chat is created
                                            displayChatHistory();
                                        }
                                    } else if (data.type === 'reasoning_chunk') {
                                        // Handle reasoning content chunks with enhanced visual indicators
                                        if (!messageDiv.querySelector('.reasoning-section')) {
                                            // Create reasoning section if it doesn't exist
                                            const reasoningSection = document.createElement('div');
                                            reasoningSection.className = 'reasoning-section';
                                            reasoningSection.style.marginTop = '15px';
                                            reasoningSection.style.padding = '16px';
                                            reasoningSection.style.backgroundColor = '#1a1a2e';
                                            reasoningSection.style.border = '1px solid #4a90e2';
                                            reasoningSection.style.borderLeft = '4px solid #4a90e2';
                                            reasoningSection.style.borderRadius = '8px';
                                            reasoningSection.style.boxShadow = '0 2px 8px rgba(74, 144, 226, 0.1)';
                                            
                                            const reasoningHeader = document.createElement('div');
                                            reasoningHeader.className = 'reasoning-header';
                                            reasoningHeader.style.fontWeight = 'bold';
                                            reasoningHeader.style.color = '#4a90e2';
                                            reasoningHeader.style.marginBottom = '12px';
                                            reasoningHeader.style.fontSize = '16px';
                                            reasoningHeader.style.display = 'flex';
                                            reasoningHeader.style.alignItems = 'center';
                                            reasoningHeader.style.gap = '8px';
                                            
                                            const thinkingIcon = document.createElement('span');
                                            thinkingIcon.textContent = '🧠';
                                            thinkingIcon.style.fontSize = '18px';
                                            
                                            const headerText = document.createElement('span');
                                            headerText.textContent = 'AI Reasoning Process';
                                            
                                            const streamingIndicator = document.createElement('span');
                                            streamingIndicator.className = 'streaming-indicator';
                                            streamingIndicator.textContent = '●';
                                            streamingIndicator.style.color = '#4a90e2';
                                            streamingIndicator.style.animation = 'pulse 1.5s infinite';
                                            streamingIndicator.style.marginLeft = 'auto';
                                            
                                            reasoningHeader.appendChild(thinkingIcon);
                                            reasoningHeader.appendChild(headerText);
                                            reasoningHeader.appendChild(streamingIndicator);
                                            
                                            const reasoningContent = document.createElement('div');
                                            reasoningContent.className = 'reasoning-content';
                                            reasoningContent.style.color = '#b8c5d6';
                                            reasoningContent.style.fontSize = '14px';
                                            reasoningContent.style.lineHeight = '1.5';
                                            reasoningContent.style.whiteSpace = 'pre-wrap';
                                            reasoningContent.style.fontFamily = 'Monaco, Consolas, "Courier New", monospace';
                                            reasoningContent.style.background = '#0f0f1a';
                                            reasoningContent.style.padding = '12px';
                                            reasoningContent.style.borderRadius = '4px';
                                            reasoningContent.style.border = '1px solid #2a2a3e';
                                            reasoningContent.style.maxHeight = '300px';
                                            reasoningContent.style.overflowY = 'auto';
                                            
                                            reasoningSection.appendChild(reasoningHeader);
                                            reasoningSection.appendChild(reasoningContent);
                                            messageDiv.appendChild(reasoningSection);
                                            
                                            // Add CSS animation for pulse effect
                                            if (!document.querySelector('#reasoning-animations')) {
                                                const style = document.createElement('style');
                                                style.id = 'reasoning-animations';
                                                style.textContent = `
                                                    @keyframes pulse {
                                                        0% { opacity: 1; }
                                                        50% { opacity: 0.3; }
                                                        100% { opacity: 1; }
                                                    }
                                                    .reasoning-chunk {
                                                        background: linear-gradient(90deg, transparent, rgba(74, 144, 226, 0.1), transparent);
                                                        animation: slideIn 0.3s ease-out;
                                                    }
                                                    @keyframes slideIn {
                                                        from { opacity: 0; transform: translateX(-10px); }
                                                        to { opacity: 1; transform: translateX(0); }
                                                    }
                                                `;
                                                document.head.appendChild(style);
                                            }
                                        }
                                        
                                        const reasoningContentDiv = messageDiv.querySelector('.reasoning-content');
                                        if (reasoningContentDiv) {
                                            // Add the new reasoning chunk with visual effect
                                            const chunkSpan = document.createElement('span');
                                            chunkSpan.className = 'reasoning-chunk';
                                            chunkSpan.textContent = data.reasoning_content;
                                            chunkSpan.style.color = '#4a90e2';
                                            reasoningContentDiv.appendChild(chunkSpan);
                                            
                                            // Scroll to bottom of reasoning content
                                            reasoningContentDiv.scrollTop = reasoningContentDiv.scrollHeight;
                                        }
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                    } else if (data.type === 'chunk') {
                                        accumulatedContent += data.content;
                                        
                                        // Create answer section header if it doesn't exist
                                        if (!messageDiv.querySelector('.answer-section')) {
                                            const answerSection = document.createElement('div');
                                            answerSection.className = 'answer-section';
                                            answerSection.style.marginTop = '15px';
                                            
                                            const answerHeader = document.createElement('div');
                                            answerHeader.className = 'answer-header';
                                            answerHeader.style.fontWeight = 'bold';
                                            answerHeader.style.color = '#4ade80';
                                            answerHeader.style.marginBottom = '12px';
                                            answerHeader.style.fontSize = '16px';
                                            answerHeader.style.display = 'flex';
                                            answerHeader.style.alignItems = 'center';
                                            answerHeader.style.gap = '8px';
                                            
                                            const answerIcon = document.createElement('span');
                                            answerIcon.textContent = '💬';
                                            answerIcon.style.fontSize = '18px';
                                            
                                            const headerText = document.createElement('span');
                                            headerText.textContent = 'AI Response';
                                            
                                            const streamingIndicator = document.createElement('span');
                                            streamingIndicator.className = 'streaming-indicator answer-streaming';
                                            streamingIndicator.textContent = '●';
                                            streamingIndicator.style.color = '#4ade80';
                                            streamingIndicator.style.animation = 'pulse 1.5s infinite';
                                            streamingIndicator.style.marginLeft = 'auto';
                                            
                                            answerHeader.appendChild(answerIcon);
                                            answerHeader.appendChild(headerText);
                                            answerHeader.appendChild(streamingIndicator);
                                            
                                            answerSection.appendChild(answerHeader);
                                            
                                            // Move the existing content div into the answer section
                                            answerSection.appendChild(contentDiv);
                                            messageDiv.appendChild(answerSection);
                                            
                                            // Style the content div for streaming
                                            contentDiv.style.padding = '12px';
                                            contentDiv.style.backgroundColor = '#0a0a0f';
                                            contentDiv.style.border = '1px solid #2a2a3e';
                                            contentDiv.style.borderRadius = '4px';
                                            contentDiv.style.minHeight = '40px';
                                            contentDiv.style.fontFamily = 'inherit';
                                            contentDiv.style.lineHeight = '1.6';
                                        }
                                        
                                        // Add streaming chunk with visual effect
                                        const chunkSpan = document.createElement('span');
                                        chunkSpan.className = 'answer-chunk';
                                        chunkSpan.textContent = data.content;
                                        chunkSpan.style.color = '#4ade80';
                                        chunkSpan.style.animation = 'slideIn 0.2s ease-out';
                                        
                                        contentDiv.appendChild(chunkSpan);
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                    } else if (data.type === 'complete') {
                                        // Remove streaming indicators
                                        const streamingIndicators = messageDiv.querySelectorAll('.streaming-indicator');
                                        streamingIndicators.forEach(indicator => indicator.remove());
                                        
                                        // Format the complete content as Markdown
                                        if (data.formatted_content && data.formatted_content.formatted_content) {
                                            contentDiv.innerHTML = data.formatted_content.formatted_content;
                                            contentDiv.classList.add('formatted');
                                        } else {
                                            try {
                                                contentDiv.innerHTML = marked.parse(data.content);
                                                contentDiv.classList.add('formatted');
                                            } catch (e) {
                                                console.warn('Failed to parse markdown, using plain text:', e);
                                                contentDiv.textContent = data.content;
                                            }
                                        }
                                        
                                        // Format reasoning content if available
                                        if (data.reasoning_content) {
                                            const reasoningContentDiv = messageDiv.querySelector('.reasoning-content');
                                            if (reasoningContentDiv) {
                                                if (data.formatted_reasoning && data.formatted_reasoning.formatted_content) {
                                                    reasoningContentDiv.innerHTML = data.formatted_reasoning.formatted_content;
                                                } else {
                                                    try {
                                                        reasoningContentDiv.innerHTML = marked.parse(data.reasoning_content);
                                                    } catch (e) {
                                                        console.warn('Failed to parse reasoning markdown, using plain text:', e);
                                                        reasoningContentDiv.textContent = data.reasoning_content;
                                                    }
                                                }
                                                reasoningContentDiv.classList.add('formatted');
                                                
                                                // Highlight code blocks in reasoning
                                                reasoningContentDiv.querySelectorAll('pre code').forEach((block) => {
                                                    hljs.highlightElement(block);
                                                });
                                            }
                                        }
                                        
                                        // Highlight code blocks in main content
                                        contentDiv.querySelectorAll('pre code').forEach((block) => {
                                            hljs.highlightElement(block);
                                        });
                                        
                                        // Add streaming statistics summary
                                        const statsDiv = document.createElement('div');
                                        statsDiv.className = 'streaming-stats';
                                        statsDiv.style.marginTop = '15px';
                                        statsDiv.style.padding = '12px';
                                        statsDiv.style.backgroundColor = '#1a1a1a';
                                        statsDiv.style.border = '1px solid #333';
                                        statsDiv.style.borderRadius = '6px';
                                        statsDiv.style.fontSize = '13px';
                                        statsDiv.style.color = '#888';
                                        
                                        const reasoningLength = data.reasoning_length || (data.reasoning_content ? data.reasoning_content.length : 0);
                                        const answerLength = data.answer_length || (data.content ? data.content.length : 0);
                                        const totalLength = reasoningLength + answerLength;
                                        const reasoningChunks = data.reasoning_chunks || 0;
                                        const answerChunks = data.answer_chunks || 0;
                                        
                                        statsDiv.innerHTML = `
                                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                                <span style="color: #4ade80; font-weight: bold;">✅ Live Streaming Complete</span>
                                                ${reasoningLength > 0 ? `<span>🧠 Reasoning: ${reasoningChunks} chunks, ${reasoningLength} chars</span>` : ''}
                                                <span>💬 Answer: ${answerChunks} chunks, ${answerLength} chars</span>
                                                <span>📝 Total: ${totalLength} chars</span>
                                                <span style="color: #4a90e2;">⚡ ${data.model || 'deepseek-reasoner'}</span>
                                            </div>
                                        `;
                                        
                                        messageDiv.appendChild(statsDiv);
                                        
                                        // Add search results if available
                                        if (data.search_results && data.search_results.length > 0) {
                                            const resultsDiv = document.createElement('div');
                                            resultsDiv.className = 'search-results';
                                            
                                            data.search_results.forEach(result => {
                                                const resultItem = document.createElement('div');
                                                resultItem.className = 'result-item';
                                                
                                                const titleDiv = document.createElement('div');
                                                titleDiv.className = 'result-title';
                                                titleDiv.textContent = result.title || 'Untitled';
                                                
                                                const contentDiv = document.createElement('div');
                                                contentDiv.className = 'result-content';
                                                contentDiv.textContent = result.content || result.snippet || '';
                                                
                                                resultItem.appendChild(titleDiv);
                                                resultItem.appendChild(contentDiv);
                                                resultsDiv.appendChild(resultItem);
                                            });
                                            
                                            messageDiv.appendChild(resultsDiv);
                                        }
                                        
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                        break;
                                    } else if (data.type === 'error') {
                                        contentDiv.textContent = 'Error: ' + data.content;
                                        contentDiv.className += ' error-message';
                                        break;
                                    } else if (data.type === 'heartbeat') {
                                        // Just continue, heartbeat to keep connection alive
                                        continue;
                                    }
                                } catch (e) {
                                    console.error('Error parsing SSE data:', e);
                                }
                            }
                        }
                    }
                    
                } catch (error) {
                    console.error('Error in streaming response:', error);
                    
                    // Remove loading message
                    const loadingMessage = document.getElementById('loading-message');
                    if (loadingMessage) {
                        loadingMessage.remove();
                    }
                    
                    // Display error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'message ai-message error-message';
                    errorDiv.textContent = 'Error: Unable to get response from the server. Please try again.';
                    chatMessages.appendChild(errorDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            // --- Auth Panel Logic ---
            const loginPanel = document.getElementById('login-panel');
            const registerPanel = document.getElementById('register-panel');
            const verificationPanel = document.getElementById('verification-panel');
            const forgotPasswordPanel = document.getElementById('forgot-password-panel');
            const toRegisterLink = document.getElementById('to-register-link');
            const toLoginLinkFromRegister = document.getElementById('to-login-link-from-register');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const backToLoginLink = document.getElementById('back-to-login-link');
            let verificationEmail = ''; // Store email for verification

            const loginNotification = document.getElementById('auth-notification-login');
            const registerNotification = document.getElementById('auth-notification-register');
            const verifyNotification = document.getElementById('auth-notification-verify');
            const forgotNotification = document.getElementById('auth-notification-forgot');

            // Track login state
            let isLoggedIn = false;
            let currentUser = null;
            const personalSessionInfo = document.getElementById('personalSessionInfo');

            function showLoginPanel() {
                loginPanel.classList.add('active');
                registerPanel.classList.remove('active');
                verificationPanel.classList.remove('active');
                forgotPasswordPanel.classList.remove('active');
            }
            function showRegisterPanel() {
                registerPanel.classList.add('active');
                loginPanel.classList.remove('active');
                verificationPanel.classList.remove('active');
                forgotPasswordPanel.classList.remove('active');
            }
            function showVerificationPanel(email) {
                verificationEmail = email;
                document.getElementById('verification-email-display').textContent = email;
                verificationPanel.classList.add('active');
                loginPanel.classList.remove('active');
                registerPanel.classList.remove('active');
                forgotPasswordPanel.classList.remove('active');
            }
            function showForgotPasswordPanel() {
                forgotPasswordPanel.classList.add('active');
                loginPanel.classList.remove('active');
                registerPanel.classList.remove('active');
                verificationPanel.classList.remove('active');
                // Pre-populate email from login form
                const loginEmail = document.getElementById('login-email').value;
                if (loginEmail) {
                    document.getElementById('forgot-password-email').value = loginEmail;
                }
            }
            function hideAuthPanels() {
                loginPanel.classList.remove('active');
                registerPanel.classList.remove('active');
                verificationPanel.classList.remove('active');
                forgotPasswordPanel.classList.remove('active');
            }
            
            function showNotification(panel, message, type = 'danger') {
                const notificationEl = document.getElementById(`auth-notification-${panel}`);
                if (notificationEl) {
                    notificationEl.textContent = message;
                    notificationEl.className = `auth-notification alert-${type}`;
                    notificationEl.style.display = 'block';
                }
            }

            function hideNotifications() {
                 ['login', 'register', 'verify', 'forgot'].forEach(panel => {
                    const notificationEl = document.getElementById(`auth-notification-${panel}`);
                    if(notificationEl) notificationEl.style.display = 'none';
                });
                // Also hide the success message for forgot password
                const forgotSuccessEl = document.getElementById('forgot-password-success');
                if(forgotSuccessEl) forgotSuccessEl.style.display = 'none';
            }

            // Function to check login status
            async function checkLoginStatus() {
                try {
                    console.log('🔍 Checking login status...');
                    const response = await fetch('/auth/session');
                    const data = await response.json();
                    console.log('📊 Session response:', data);
                    
                    if (data.logged_in && data.user) {
                        isLoggedIn = true;
                        currentUser = data.user;
                        hideAuthPanels();
                        console.log('✅ User is logged in:', currentUser);
                        
                        // Update personal panel with user info
                        const personalSessionInfo = document.getElementById('personalSessionInfo');
                        if (personalSessionInfo) {
                            personalSessionInfo.innerHTML = `
                                <div style="margin-bottom: 8px;">
                                    <strong>${currentUser.username || currentUser.email_masked || 'User'}</strong>
                                </div>
                                <div style="font-size: 0.9em; color: #888;">
                                    ${currentUser.provider ? `via ${currentUser.provider}` : 'Email login'}
                                </div>
                                ${currentUser.email_masked ? `<div style="font-size: 0.85em; color: #666; margin-top: 4px;">${currentUser.email_masked}</div>` : ''}
                            `;
                        }
                        
                        // Check if user is admin and show admin link
                        checkAdminStatus();
                        
                        // Load chat history when user is logged in
                        loadChatHistoryOnLogin();
                        
                        // Show a success message or update UI
                        const welcomeMessage = document.querySelector('.welcome-message');
                        if (welcomeMessage) {
                            welcomeMessage.innerHTML = `<span class="welcome-icon">👋</span>Welcome back, ${currentUser.username || currentUser.email_masked}!`;
                        }
                        
                    } else {
                        isLoggedIn = false;
                        currentUser = null;
                        
                        // Update personal panel for logged out state
                        const personalSessionInfo = document.getElementById('personalSessionInfo');
                        if (personalSessionInfo) {
                            personalSessionInfo.innerHTML = `
                                <div style="margin-bottom: 8px; color: #888;">
                                    Not logged in
                                </div>
                                <div style="font-size: 0.9em; color: #666;">
                                    Please login to access features
                                </div>
                            `;
                        }
                        
                        // Show not logged in state in chat history
                        loadChatHistoryOnLogin();
                        
                        showLoginPanel();
                        console.log('❌ User is not logged in');
                    }
                } catch (error) {
                    console.error('❌ Error checking login status:', error);
                    isLoggedIn = false;
                    currentUser = null;
                    
                    // Update personal panel for error state
                    const personalSessionInfo = document.getElementById('personalSessionInfo');
                    if (personalSessionInfo) {
                        personalSessionInfo.innerHTML = `
                            <div style="margin-bottom: 8px; color: #888;">
                                Not logged in
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                Please login to access features
                            </div>
                        `;
                    }
                    
                    // Show not logged in state in chat history
                    loadChatHistoryOnLogin();
                    
                    showLoginPanel();
                }
            }
            
            // Function to check if current user is admin
            async function checkAdminStatus() {
                try {
                    if (!isLoggedIn || !currentUser) {
                        // Hide admin link if not logged in
                        const adminLinkContainer = document.getElementById('adminLinkContainer');
                        if (adminLinkContainer) {
                            adminLinkContainer.style.display = 'none';
                        }
                        return;
                    }
                    
                    console.log('🔍 Checking admin status...');
                    const response = await fetch('/admin', {
                        method: 'HEAD' // Use HEAD to just check access without loading the page
                    });
                    
                    const adminLinkContainer = document.getElementById('adminLinkContainer');
                    if (adminLinkContainer) {
                        if (response.ok) {
                            // User is admin, show the link
                            adminLinkContainer.style.display = 'block';
                            console.log('✅ User has admin access');
                        } else {
                            // User is not admin, hide the link
                            adminLinkContainer.style.display = 'none';
                            console.log('❌ User does not have admin access');
                        }
                    }
                } catch (error) {
                    console.error('❌ Error checking admin status:', error);
                    // Hide admin link on error
                    const adminLinkContainer = document.getElementById('adminLinkContainer');
                    if (adminLinkContainer) {
                        adminLinkContainer.style.display = 'none';
                    }
                }
            }

            // Check login status on page load
            checkLoginStatus();
            
            // Check if we just came back from OAuth (detect URL changes or page reload after auth)
            window.addEventListener('focus', function() {
                // Re-check login status when window regains focus (after OAuth popup/redirect)
                setTimeout(checkLoginStatus, 500);
            });
            
            // Check for OAuth callback in URL and recheck session
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') || urlParams.has('auth') || window.location.pathname.includes('/auth/')) {
                console.log('🔄 OAuth callback detected, rechecking session...');
                // We might have just completed OAuth, recheck session after a short delay
                setTimeout(checkLoginStatus, 1000);
                setTimeout(checkLoginStatus, 3000); // Double check after 3 seconds
                
                // Clean up the URL by removing auth parameters
                if (urlParams.has('auth') && urlParams.get('auth') === 'success') {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
            }
            
            // Also check session periodically to catch any auth state changes
            setInterval(checkLoginStatus, 30000); // Check every 30 seconds
            
            toRegisterLink.addEventListener('click', () => {
                hideNotifications();
                showRegisterPanel();
            });
            toLoginLinkFromRegister.addEventListener('click', () => {
                hideNotifications();
                showLoginPanel();
            });
            forgotPasswordLink.addEventListener('click', () => {
                hideNotifications();
                showForgotPasswordPanel();
            });
            backToLoginLink.addEventListener('click', () => {
                hideNotifications();
                showLoginPanel();
            });

            // --- Handle Email Registration ---
            document.getElementById('email-register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideNotifications();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                
                try {
                    const response = await fetch('/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showVerificationPanel(data.email);
                    } else {
                        showNotification('register', data.error || 'Registration failed.');
                    }
                } catch (error) {
                    showNotification('register', 'An error occurred during registration.');
                }
            });

            // --- Handle Email Login ---
            document.getElementById('email-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideNotifications();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                try {
                    const response = await fetch('/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        await checkLoginStatus(); // Re-check status to update UI and hide panels
                    } else {
                         if (data.email_not_verified) {
                            showVerificationPanel(data.email);
                        } else {
                            showNotification('login', data.error || 'Login failed.');
                        }
                    }
                } catch (error) {
                    showNotification('login', 'An error occurred during login.');
                }
            });

            // --- Handle Verification ---
            document.getElementById('verify-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideNotifications();
                const code = document.getElementById('verification-code').value;

                try {
                    const response = await fetch('/auth/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: verificationEmail, code })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        await checkLoginStatus(); // Re-check status to update UI and hide panels
                    } else {
                        showNotification('verify', data.error || 'Verification failed.');
                    }
                } catch (error) {
                    showNotification('verify', 'An error occurred during verification.');
                }
            });
            
            // --- Handle Resend Code ---
            document.getElementById('resend-verification-code').addEventListener('click', async (e) => {
                e.preventDefault();
                hideNotifications();
                // This password is a placeholder, the backend just needs it to exist on the payload
                const password = "dummy-password-for-resend";
                try {
                     const response = await fetch('/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: verificationEmail, password })
                    });
                     const data = await response.json();
                     if(response.ok) {
                        showNotification('verify', 'A new verification code has been sent.', 'success');
                     } else {
                        showNotification('verify', data.error || 'Failed to resend code.');
                     }
                } catch(err) {
                    showNotification('verify', 'An error occurred while resending the code.');
                }
            });

            // --- Handle Forgot Password ---
            document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideNotifications();
                const email = document.getElementById('forgot-password-email').value;

                try {
                    const response = await fetch('/auth/forgot-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Show success message
                        const successEl = document.getElementById('forgot-password-success');
                        if (successEl) {
                            successEl.style.display = 'block';
                        }
                        // Clear the form
                        document.getElementById('forgot-password-email').value = '';
                    } else {
                        showNotification('forgot', data.error || 'Failed to send reset email.');
                    }
                } catch (error) {
                    showNotification('forgot', 'An error occurred. Please try again.');
                }
            });

            // --- Google Sign-In Integration ---
            function handleGoogleCredentialResponse(response) {
                // response.credential is the ID token
                fetch('/auth/google', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id_token: response.credential,
                        redirect_uri: 'http://localhost:8100/auth/google/callback'
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        isLoggedIn = true;
                        currentUser = data.user;
                        hideAuthPanels();
                        console.log('Google authentication successful:', currentUser);
                        
                        // Store user info in localStorage
                        if (data.user) {
                            localStorage.setItem('user', JSON.stringify(data.user));
                        }
                        
                        // Update UI immediately without reload
                        checkLoginStatus();
                    } else {
                        alert('Google authentication failed: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Google authentication error:', err);
                    alert('Google authentication error: ' + err);
                });
            }

            // Render Google Sign-In button for login
            window.onload = function() {
                if (window.google && google.accounts && google.accounts.id) {
                    google.accounts.id.initialize({
                        client_id: '{{ google_client_id }}', // Will be replaced with actual client ID from backend
                        callback: handleGoogleCredentialResponse,
                        auto_select: false,
                        cancel_on_tap_outside: true,
                        context: 'signin'
                    });
                    
                    // Login panel
                    google.accounts.id.renderButton(
                        document.getElementById('google-login-btn'),
                        { 
                            theme: 'outline', 
                            size: 'large', 
                            width: 260, 
                            text: 'signin_with',
                            type: 'standard'
                        }
                    );
                    
                    // Registration panel
                    google.accounts.id.renderButton(
                        document.getElementById('google-register-btn'),
                        { 
                            theme: 'outline', 
                            size: 'large', 
                            width: 260, 
                            text: 'signup_with',
                            type: 'standard'
                        }
                    );
                }
            };

            // GitHub OAuth handlers
            function handleGitHubAuth() {
                // Redirect to GitHub OAuth
                window.location.href = '/auth/github';
            }

            // GitHub login button
            const githubLoginBtn = document.getElementById('github-login-btn');
            if (githubLoginBtn) {
                githubLoginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleGitHubAuth();
                });
            }

            // GitHub register button
            const githubRegisterBtn = document.getElementById('github-register-btn');
            if (githubRegisterBtn) {
                githubRegisterBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleGitHubAuth();
                });
            }

            // If user clicks the custom Google button in registration panel, trigger the Google sign-in
            const customGoogleRegisterBtn = document.getElementById('google-register-btn');
            if (customGoogleRegisterBtn) {
                customGoogleRegisterBtn.addEventListener('click', function(e) {
                    // Prevent default if using Google button
                    e.preventDefault();
                    // The real Google button will be rendered inside this button
                });
            }
            // If user clicks the custom Google button in login panel, trigger the Google sign-in
            const customGoogleLoginBtn = document.getElementById('github-login-btn');
            if (customGoogleLoginBtn) {
                customGoogleLoginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                });
            }

            // Sidebar open/close logic
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            let sidebarOpen = true;
            function updateSidebar() {
                if (sidebarOpen) {
                    sidebar.classList.remove('closed');
                    sidebarToggleBtn.innerHTML = '&#x25C0;';
                    sidebarToggleBtn.title = 'Close sidebar';
                } else {
                    sidebar.classList.add('closed');
                    sidebarToggleBtn.innerHTML = '&#x25B6;';
                    sidebarToggleBtn.title = 'Open sidebar';
                }
            }
            sidebarToggleBtn.addEventListener('click', () => {
                sidebarOpen = !sidebarOpen;
                updateSidebar();
            });
            // Initial state
            updateSidebar();

            // Personal panel logic
            const personalIcon = document.getElementById('personalIcon');
            const personalPanel = document.getElementById('personalPanel');
            let personalPanelOpen = false;
            personalIcon.addEventListener('click', (e) => {
                personalPanelOpen = !personalPanelOpen;
                if (personalPanelOpen) {
                    personalPanel.classList.add('open');
                } else {
                    personalPanel.classList.remove('open');
                }
            });
            // Hide personal panel when clicking outside
            document.addEventListener('mousedown', (e) => {
                if (personalPanelOpen && !personalPanel.contains(e.target) && !personalIcon.contains(e.target)) {
                    personalPanel.classList.remove('open');
                    personalPanelOpen = false;
                }
            });
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    console.log('🚪 Logging out...');
                    const response = await fetch('/auth/logout', { method: 'GET', credentials: 'include' });
                    const data = await response.json();
                    console.log('📤 Logout response:', data);
                    
                    if (data.success) {
                        // Clear user state and show login panel
                        isLoggedIn = false;
                        currentUser = null;
                        
                        // Clear personal panel info
                        const personalSessionInfo = document.getElementById('personalSessionInfo');
                        if (personalSessionInfo) {
                            personalSessionInfo.innerHTML = `
                                <div style="margin-bottom: 8px; color: #888;">
                                    Not logged in
                                </div>
                                <div style="font-size: 0.9em; color: #666;">
                                    Please login to access features
                                </div>
                            `;
                        }
                        
                        // Clear localStorage
                        localStorage.removeItem('user');
                        // Reset welcome message
                        const welcomeMessage = document.querySelector('.welcome-message');
                        if (welcomeMessage) {
                            welcomeMessage.innerHTML = '<span class="welcome-icon">🔍</span>Welcome to Dxee Chat';
                        }
                        showLoginPanel();
                        personalPanel.classList.remove('open');
                        personalPanelOpen = false;
                        // Recheck login status to ensure UI is updated
                        setTimeout(checkLoginStatus, 500);
                        console.log('✅ Logout successful');
                    } else {
                        console.error('❌ Logout failed:', data);
                        alert('Logout failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.error('❌ Logout error:', e);
                    alert('Logout failed: ' + e.message);
                }
            });

            // Chat History functionality
            let chatHistoryCache = [];
            
            // Function to fetch user's chat history
            async function fetchChatHistory() {
                try {
                    const response = await fetch('/chat/user?limit=10&skip=0');
                    if (!response.ok) {
                        throw new Error('Failed to fetch chat history');
                    }
                    const data = await response.json();
                    return data.chats || [];
                } catch (error) {
                    console.error('Error fetching chat history:', error);
                    return [];
                }
            }
            
            // Function to display chat history in sidebar
            function displayChatHistory(chats) {
                const loadingDiv = document.getElementById('chat-history-loading');
                const listDiv = document.getElementById('chatHistoryList');
                
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (listDiv) listDiv.style.display = 'block';
                
                if (!chats || chats.length === 0) {
                    listDiv.innerHTML = '<li style="text-align: center; color: #888; font-size: 11px; padding: 20px 10px;">No chat history</li>';
                    return;
                }
                
                listDiv.innerHTML = '';
                chats.forEach((chat, index) => {
                    const li = document.createElement('li');
                    li.className = 'chat-history-item';
                    li.dataset.chatId = chat.chat_id;
                    
                    // Truncate title to 30 characters as requested
                    const title = chat.title ? (chat.title.length > 30 ? chat.title.substring(0, 30) + '...' : chat.title) : 'New Chat';
                    
                    // Format date
                    const date = chat.updated_at ? new Date(chat.updated_at).toLocaleDateString() : new Date(chat.created_at).toLocaleDateString();
                    
                    li.innerHTML = `
                        <div class="chat-history-item-title">${title}</div>
                        <div class="chat-history-item-date">${date}</div>
                    `;
                    
                    // Add click handler to load chat
                    li.addEventListener('click', () => loadChatHistory(chat.chat_id, li));
                    
                    listDiv.appendChild(li);
                });
            }
            
            // Function to load a specific chat history
            async function loadChatHistory(chatId, itemElement) {
                try {
                    // Update UI to show active chat
                    document.querySelectorAll('.chat-history-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    if (itemElement) {
                        itemElement.classList.add('active');
                    }
                    
                    // Set current chat ID
                    currentChatId = chatId;
                    
                    // Fetch chat messages
                    const response = await fetch(`/chat/history/${chatId}`);
                    if (!response.ok) {
                        throw new Error('Failed to load chat history');
                    }
                    
                    const data = await response.json();
                    const messages = data.messages || [];
                    
                    // Clear current chat messages
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '';
                    }
                    
                    // Show chat screen and hide welcome screen
                    welcomeScreen.classList.add('hidden');
                    chatScreen.classList.remove('hidden');
                    
                    // Display all messages
                    messages.forEach(message => {
                        if (message.type === 'user') {
                            addUserMessage(message.message);
                        } else if (message.type === 'assistant') {
                            addAIMessage(message.message, message.search_results || []);
                        }
                    });
                    
                    // Scroll to bottom
                    if (chatMessages) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    alert('Failed to load chat history: ' + error.message);
                }
            }
            
            // Function to load chat history on page load (only if logged in)
            async function loadChatHistoryOnLogin() {
                if (!isLoggedIn) {
                    // Show not logged in state
                    const loadingDiv = document.getElementById('chat-history-loading');
                    const listDiv = document.getElementById('chatHistoryList');
                    if (loadingDiv) {
                        loadingDiv.textContent = 'Please log in';
                        loadingDiv.style.display = 'block';
                    }
                    if (listDiv) {
                        listDiv.style.display = 'none';
                    }
                    return;
                }
                
                try {
                    const chats = await fetchChatHistory();
                    chatHistoryCache = chats;
                    displayChatHistory(chats);
                } catch (error) {
                    console.error('Error loading initial chat history:', error);
                    const loadingDiv = document.getElementById('chat-history-loading');
                    if (loadingDiv) {
                        loadingDiv.textContent = 'Failed to load';
                    }
                }
            }
            
            // Function to refresh chat history (e.g., after sending a new message)
            async function refreshChatHistory() {
                try {
                    const chats = await fetchChatHistory();
                    chatHistoryCache = chats;
                    displayChatHistory(chats);
                } catch (error) {
                    console.error('Error refreshing chat history:', error);
                }
            }

            // Dual Research functionality for Google Deep button
            let isDualResearching = false;

            // Handle Google Deep with Dual Research
            async function handleDualResearch(message) {
                if (isDualResearching) return;
                
                isDualResearching = true;
                console.log('🔍 Starting Dual Research for:', message);
                
                // Show dual research progress
                addDualResearchProgress();
                
                try {
                    // Make HTTP request to dual research endpoint
                    const response = await fetch('/dual-research', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            question: message
                        }),
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const results = await response.json();
                    
                    if (results.status === 'success') {
                        displayDualResearchResults(results);
                        // Refresh chat history if a new chat was created
                        if (results.chat_id) {
                            currentChatId = results.chat_id;
                            displayChatHistory();
                        }
                    } else {
                        showDualResearchError(results.message || 'Unknown error');
                    }
                    
                } catch (error) {
                    console.error('Dual research error:', error);
                    showDualResearchError('Failed to conduct dual research: ' + error.message);
                } finally {
                    isDualResearching = false;
                }
            }

            function addDualResearchProgress() {
                // Remove loading message and add progress indicator
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    const progressDiv = document.createElement('div');
                    progressDiv.className = 'dual-research-progress';
                    progressDiv.id = 'dual-research-progress';
                    progressDiv.style.marginTop = '15px';
                    progressDiv.style.padding = '20px';
                    progressDiv.style.backgroundColor = '#1a1a2e';
                    progressDiv.style.border = '1px solid #4a90e2';
                    progressDiv.style.borderLeft = '4px solid #4a90e2';
                    progressDiv.style.borderRadius = '8px';
                    progressDiv.style.boxShadow = '0 2px 8px rgba(74, 144, 226, 0.1)';
                    
                    progressDiv.innerHTML = `
                        <div style="font-weight: bold; color: #4a90e2; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <span>🔍</span>
                            <span>Dual Research in Progress</span>
                            <span style="margin-left: auto; animation: pulse 1.5s infinite;">●</span>
                        </div>
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 1; padding: 10px; background: #2a2a3e; border-radius: 6px; border-left: 3px solid #4ade80;">
                                <div style="font-weight: bold; color: #4ade80; margin-bottom: 5px;">🧠 Intelligent Research</div>
                                <div style="font-size: 12px; color: #b8c5d6;">Analyzes if web search is needed first</div>
                            </div>
                            <div style="flex: 1; padding: 10px; background: #2a2a3e; border-radius: 6px; border-left: 3px solid #ff9776;">
                                <div style="font-weight: bold; color: #ff9776; margin-bottom: 5px;">⚡ Legacy Research</div>
                                <div style="font-size: 12px; color: #b8c5d6;">Always performs comprehensive web search</div>
                            </div>
                        </div>
                        <div style="text-align: center; color: #888; font-size: 14px;">
                            Running both research approaches simultaneously...
                        </div>
                    `;
                    
                    loadingMessage.parentNode.replaceChild(progressDiv, loadingMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            function displayDualResearchResults(results) {
                // Remove progress indicator
                const progressDiv = document.getElementById('dual-research-progress');
                if (progressDiv) {
                    progressDiv.remove();
                }
                
                // Create dual results display
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.style.width = '845px';
                messageDiv.style.maxWidth = '90%';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon ai-icon';
                iconSpan.textContent = '🔍';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Dual Research Results';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                headerDiv.appendChild(iconSpan);
                headerDiv.appendChild(nameSpan);
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                
                // Create side-by-side results layout
                const resultsContainer = document.createElement('div');
                resultsContainer.style.display = 'flex';
                resultsContainer.style.gap = '20px';
                resultsContainer.style.marginTop = '15px';
                
                // Intelligent Research Result
                const intelligentDiv = createResearchResultDiv(results.intelligent_research, 'Intelligent Research', '#4ade80', '🧠');
                
                // Legacy Research Result  
                const legacyDiv = createResearchResultDiv(results.legacy_research, 'Legacy Research', '#ff9776', '⚡');
                
                resultsContainer.appendChild(intelligentDiv);
                resultsContainer.appendChild(legacyDiv);
                contentDiv.appendChild(resultsContainer);
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function createResearchResultDiv(research, title, color, icon) {
                const div = document.createElement('div');
                div.style.flex = '1';
                div.style.padding = '15px';
                div.style.backgroundColor = '#1a1a2e';
                div.style.border = `1px solid ${color}`;
                div.style.borderLeft = `4px solid ${color}`;
                div.style.borderRadius = '8px';
                div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                
                const headerDiv = document.createElement('div');
                headerDiv.style.fontWeight = 'bold';
                headerDiv.style.color = color;
                headerDiv.style.marginBottom = '12px';
                headerDiv.style.fontSize = '16px';
                headerDiv.style.display = 'flex';
                headerDiv.style.alignItems = 'center';
                headerDiv.style.gap = '8px';
                headerDiv.innerHTML = `<span>${icon}</span><span>${title}</span>`;
                
                const contentDiv = document.createElement('div');
                contentDiv.style.color = '#e0e0e0';
                contentDiv.style.fontSize = '14px';
                contentDiv.style.lineHeight = '1.5';
                
                if (research.approach === 'direct_answer') {
                    // Direct answer without web search
                    const answerDiv = document.createElement('div');
                    answerDiv.style.background = '#0a0a0f';
                    answerDiv.style.padding = '12px';
                    answerDiv.style.borderRadius = '4px';
                    answerDiv.style.border = '1px solid #2a2a3e';
                    answerDiv.style.marginBottom = '10px';
                    
                    const answerLabel = document.createElement('div');
                    answerLabel.style.fontWeight = 'bold';
                    answerLabel.style.color = color;
                    answerLabel.style.marginBottom = '8px';
                    answerLabel.textContent = '🎯 Direct Answer';
                    
                    const answerText = document.createElement('div');
                    answerText.textContent = research.direct_answer || 'No direct answer available';
                    
                    answerDiv.appendChild(answerLabel);
                    answerDiv.appendChild(answerText);
                    contentDiv.appendChild(answerDiv);
                } else if (research.approach === 'web_search_research' || research.approach === 'legacy_web_search') {
                    // Web search results
                    if (research.steps && research.steps.step2 && research.steps.step2.search_results) {
                        const searchHeader = document.createElement('div');
                        searchHeader.style.fontWeight = 'bold';
                        searchHeader.style.color = color;
                        searchHeader.style.marginBottom = '8px';
                        searchHeader.textContent = '🔍 Search Results';
                        contentDiv.appendChild(searchHeader);
                        
                        const resultsDiv = document.createElement('div');
                        resultsDiv.style.maxHeight = '200px';
                        resultsDiv.style.overflowY = 'auto';
                        
                        research.steps.step2.search_results.slice(0, 3).forEach(result => {
                            const resultItem = document.createElement('div');
                            resultItem.style.marginBottom = '10px';
                            resultItem.style.padding = '8px';
                            resultItem.style.background = '#0a0a0f';
                            resultItem.style.borderRadius = '4px';
                            resultItem.style.border = '1px solid #2a2a3e';
                            
                            const titleDiv = document.createElement('div');
                            titleDiv.style.fontWeight = 'bold';
                            titleDiv.style.color = '#1a73e8';
                            titleDiv.style.marginBottom = '3px';
                            titleDiv.style.fontSize = '12px';
                            titleDiv.textContent = result.title;
                            
                            const snippetDiv = document.createElement('div');
                            snippetDiv.style.fontSize = '11px';
                            snippetDiv.style.color = '#b8c5d6';
                            snippetDiv.style.lineHeight = '1.3';
                            snippetDiv.textContent = result.snippet.substring(0, 100) + '...';
                            
                            resultItem.appendChild(titleDiv);
                            resultItem.appendChild(snippetDiv);
                            resultsDiv.appendChild(resultItem);
                        });
                        
                        contentDiv.appendChild(resultsDiv);
                    }
                    
                    // AI Analysis
                    if (research.steps && research.steps.step4 && research.steps.step4.analysis) {
                        const analysisHeader = document.createElement('div');
                        analysisHeader.style.fontWeight = 'bold';
                        analysisHeader.style.color = color;
                        analysisHeader.style.marginTop = '12px';
                        analysisHeader.style.marginBottom = '8px';
                        analysisHeader.textContent = '🧠 AI Analysis';
                        contentDiv.appendChild(analysisHeader);
                        
                        const analysisDiv = document.createElement('div');
                        analysisDiv.style.background = '#0a0a0f';
                        analysisDiv.style.padding = '10px';
                        analysisDiv.style.borderRadius = '4px';
                        analysisDiv.style.border = '1px solid #2a2a3e';
                        analysisDiv.style.maxHeight = '150px';
                        analysisDiv.style.overflowY = 'auto';
                        analysisDiv.style.fontSize = '12px';
                        
                        const analysisText = research.steps.step4.analysis.analysis_content || 'No analysis available';
                        analysisDiv.textContent = analysisText.substring(0, 500) + (analysisText.length > 500 ? '...' : '');
                        
                        contentDiv.appendChild(analysisDiv);
                    }
                }
                
                // Research stats
                const statsDiv = document.createElement('div');
                statsDiv.style.marginTop = '10px';
                statsDiv.style.padding = '8px';
                statsDiv.style.background = '#2a2a3e';
                statsDiv.style.borderRadius = '4px';
                statsDiv.style.fontSize = '11px';
                statsDiv.style.color = '#888';
                
                const researchType = research.research_type || 'unknown';
                const approach = research.approach || 'unknown';
                statsDiv.innerHTML = `
                    <div>Type: ${researchType}</div>
                    <div>Approach: ${approach}</div>
                    <div>Success: ${research.success ? '✅' : '❌'}</div>
                `;
                
                contentDiv.appendChild(statsDiv);
                
                div.appendChild(headerDiv);
                div.appendChild(contentDiv);
                return div;
            }

            function showDualResearchError(message) {
                const progressDiv = document.getElementById('dual-research-progress');
                if (progressDiv) {
                    progressDiv.remove();
                }
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message ai-message error-message';
                errorDiv.style.width = '845px';
                errorDiv.style.maxWidth = '90%';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon ai-icon';
                iconSpan.textContent = '❌';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Dual Research Error';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = message;
                
                headerDiv.appendChild(iconSpan);
                headerDiv.appendChild(nameSpan);
                errorDiv.appendChild(headerDiv);
                errorDiv.appendChild(contentDiv);
                
                chatMessages.appendChild(errorDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function updateDeepSearchProgress_OLD(step, data) {
                const progressDiv = document.getElementById('deep-search-progress');
                if (!progressDiv) return;
                
                function updateProgressStep(stepId, status) {
                    const stepElement = document.getElementById(stepId);
                    if (!stepElement) return;
                    
                    const icon = stepElement.querySelector('.step-icon');
                    
                    // Remove all status classes
                    stepElement.classList.remove('active', 'completed', 'error');
                    icon.classList.remove('pending', 'active', 'completed', 'error');
                    
                    // Add new status
                    stepElement.classList.add(status);
                    icon.classList.add(status);
                    
                    // Update styles and icon content
                    if (status === 'active') {
                        stepElement.style.background = '#e8f0fe';
                        stepElement.style.borderLeft = '3px solid #4a90e2';
                        icon.style.background = '#4a90e2';
                        icon.style.color = 'white';
                        icon.style.animation = 'pulse 1.5s infinite';
                    } else if (status === 'completed') {
                        stepElement.style.background = '#d4edda';
                        stepElement.style.borderLeft = '3px solid #28a745';
                        icon.style.background = '#28a745';
                        icon.style.color = 'white';
                        icon.style.animation = 'none';
                        icon.textContent = '✓';
                    } else if (status === 'error') {
                        stepElement.style.background = '#f8d7da';
                        stepElement.style.borderLeft = '3px solid #dc3545';
                        icon.style.background = '#dc3545';
                        icon.style.color = 'white';
                        icon.style.animation = 'none';
                        icon.textContent = '✗';
                    }
                }
                
                switch(step) {
                    case 'step0_start':
                        updateProgressStep('step0', 'active');
                        break;
                    case 'step0_complete':
                        updateProgressStep('step0', 'completed');
                        if (data.web_search_needed) {
                            updateProgressStep('step1', 'active');
                        }
                        break;
                    case 'step2_start':
                        updateProgressStep('step1', 'completed');
                        updateProgressStep('step2', 'active');
                        break;
                    case 'step2_complete':
                        updateProgressStep('step2', 'completed');
                        updateProgressStep('step3', 'active');
                        break;
                    case 'step3_complete':
                        updateProgressStep('step3', 'completed');
                        break;
                    case 'step4_complete':
                        updateProgressStep('step3', 'completed');
                        break;
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function handleDeepSearchComplete(results) {
                resetDeepSearchState();
                displayDeepSearchResults(results);
            }

            function displayDeepSearchResults(results) {
                // Remove progress indicator
                const progressDiv = document.getElementById('deep-search-progress');
                if (progressDiv) {
                    progressDiv.remove();
                }
                
                // Create results display
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.style.width = '845px';
                messageDiv.style.maxWidth = '90%';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon ai-icon';
                iconSpan.textContent = '🔍';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Google Deep Search';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                headerDiv.appendChild(iconSpan);
                headerDiv.appendChild(nameSpan);
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                
                if (results.research_type === 'direct_answer') {
                    // Direct answer without web search
                    const answerDiv = document.createElement('div');
                    answerDiv.style.background = 'linear-gradient(135deg, #e3f2fd, #f3e5f5)';
                    answerDiv.style.border = '1px solid #4a90e2';
                    answerDiv.style.borderRadius = '8px';
                    answerDiv.style.padding = '20px';
                    answerDiv.style.marginTop = '15px';
                    
                    const answerHeader = document.createElement('h4');
                    answerHeader.style.color = '#4a90e2';
                    answerHeader.style.marginTop = '0';
                    answerHeader.textContent = '🎯 Direct Answer';
                    
                    const answerContent = document.createElement('div');
                    answerContent.style.lineHeight = '1.6';
                    answerContent.style.color = '#424242';
                    answerContent.textContent = results.direct_answer;
                    
                    answerDiv.appendChild(answerHeader);
                    answerDiv.appendChild(answerContent);
                    contentDiv.appendChild(answerDiv);
                } else {
                    // Web search results
                    if (results.steps.step2 && results.steps.step2.search_results) {
                        const searchHeader = document.createElement('h4');
                        searchHeader.textContent = '🔍 Search Results';
                        searchHeader.style.color = '#4a90e2';
                        contentDiv.appendChild(searchHeader);
                        
                        results.steps.step2.search_results.forEach(result => {
                            const resultItem = document.createElement('div');
                            resultItem.style.marginBottom = '15px';
                            resultItem.style.padding = '15px';
                            resultItem.style.background = '#1a1a2e';
                            resultItem.style.borderRadius = '6px';
                            resultItem.style.borderLeft = '3px solid #4a90e2';
                            
                            const titleDiv = document.createElement('div');
                            titleDiv.style.fontWeight = 'bold';
                            titleDiv.style.color = '#1a73e8';
                            titleDiv.style.marginBottom = '5px';
                            titleDiv.textContent = result.title;
                            
                            const urlDiv = document.createElement('div');
                            urlDiv.style.fontSize = '12px';
                            urlDiv.style.color = '#5f6368';
                            urlDiv.style.marginBottom = '8px';
                            urlDiv.textContent = result.link;
                            
                            const snippetDiv = document.createElement('div');
                            snippetDiv.style.color = '#3c4043';
                            snippetDiv.style.lineHeight = '1.4';
                            snippetDiv.style.fontSize = '14px';
                            snippetDiv.textContent = result.snippet;
                            
                            resultItem.appendChild(titleDiv);
                            resultItem.appendChild(urlDiv);
                            resultItem.appendChild(snippetDiv);
                            contentDiv.appendChild(resultItem);
                        });
                    }
                    
                    // AI Analysis
                    if (results.steps.step4 && results.steps.step4.analysis) {
                        const analysisHeader = document.createElement('h4');
                        analysisHeader.textContent = '🧠 AI Analysis';
                        analysisHeader.style.color = '#4ade80';
                        analysisHeader.style.marginTop = '20px';
                        contentDiv.appendChild(analysisHeader);
                        
                        const analysisContent = document.createElement('div');
                        analysisContent.style.background = '#0a0a0f';
                        analysisContent.style.padding = '15px';
                        analysisContent.style.borderRadius = '6px';
                        analysisContent.style.lineHeight = '1.6';
                        analysisContent.style.color = '#e0e0e0';
                        analysisContent.style.border = '1px solid #2a2a3e';
                        
                        try {
                            analysisContent.innerHTML = marked.parse(results.steps.step4.analysis.analysis_content);
                        } catch (e) {
                            analysisContent.textContent = results.steps.step4.analysis.analysis_content;
                        }
                        
                        contentDiv.appendChild(analysisContent);
                    }
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function showDeepSearchError(message) {
                const progressDiv = document.getElementById('deep-search-progress');
                if (progressDiv) {
                    progressDiv.remove();
                }
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message ai-message error-message';
                errorDiv.style.width = '845px';
                errorDiv.style.maxWidth = '90%';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'message-icon ai-icon';
                iconSpan.textContent = '❌';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = 'Deep Search Error';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = message;
                
                headerDiv.appendChild(iconSpan);
                headerDiv.appendChild(nameSpan);
                errorDiv.appendChild(headerDiv);
                errorDiv.appendChild(contentDiv);
                
                chatMessages.appendChild(errorDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                resetDeepSearchState();
            }

            function resetDeepSearchState() {
                isDeepSearching = false;
                if (currentWebSocket) {
                    currentWebSocket.close();
                    currentWebSocket = null;
                }
            }

            // Note: Dual research is now handled directly in form submission logic above
        });

        // Auth logic
        document.addEventListener('DOMContentLoaded', function () {
            // ... existing auth logic ...
            const googleLoginBtn = document.getElementById('google-login-btn');
            const githubLoginBtn = document.getElementById('github-login-btn');
            const emailLoginBtn = document.getElementById('email-login-btn');

            const authSelection = document.getElementById('auth-selection');
            const emailLoginForm = document.getElementById('email-login-form');
            const emailRegisterForm = document.getElementById('email-register-form');
            const emailVerificationForm = document.getElementById('email-verification-form');
            const authNotification = document.getElementById('auth-notification');

            let verificationEmail = ''; // Store email for verification

            function showNotification(message, type = 'danger') {
                authNotification.textContent = message;
                authNotification.className = `alert alert-${type}`;
                authNotification.style.display = 'block';
            }

            function hideNotification() {
                authNotification.style.display = 'none';
            }
            
            function showForm(formElement) {
                document.querySelectorAll('.auth-form, #auth-selection, .verification-form').forEach(el => el.classList.remove('active'));
                formElement.classList.add('active');
                hideNotification();
            }

            // Event Listeners for switching forms
            emailLoginBtn.addEventListener('click', () => showForm(emailLoginForm));
            document.getElementById('show-register-form').addEventListener('click', (e) => {
                e.preventDefault();
                showForm(emailRegisterForm);
            });
            document.getElementById('show-login-form').addEventListener('click', (e) => {
                e.preventDefault();
                showForm(emailLoginForm);
            });
            document.querySelectorAll('.back-to-auth-selection').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    showForm(authSelection);
                });
            });

            // Handle Registration
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideNotification();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                
                try {
                    const response = await fetch('/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        verificationEmail = data.email;
                        document.getElementById('verification-email-display').textContent = verificationEmail;
                        showForm(emailVerificationForm);
                    } else {
                        showNotification(data.error || 'Registration failed.');
                    }
                } catch (error) {
                    showNotification('An error occurred during registration.');
                }
            });

            // Handle Verification
            document.getElementById('verify-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideNotification();
                const code = document.getElementById('verification-code').value;

                try {
                    const response = await fetch('/auth/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: verificationEmail, code })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showNotification('Login successful!', 'success');
                        window.location.reload(); // Reload to update UI
                    } else {
                        showNotification(data.error || 'Verification failed.');
                    }
                } catch (error) {
                    showNotification('An error occurred during verification.');
                }
            });

            // Handle resending verification code
            document.getElementById('resend-verification-code').addEventListener('click', async (e) => {
                e.preventDefault();
                hideNotification();
                // We can re-use the register form's logic to resend.
                // It's safe because the backend handles existing unverified users.
                const password = "dummy-password-for-resend"; // Not used, but API expects it
                try {
                     const response = await fetch('/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: verificationEmail, password })
                    });
                     const data = await response.json();
                     if(response.ok) {
                        showNotification('A new verification code has been sent.', 'success');
                     } else {
                        showNotification(data.error || 'Failed to resend code.');
                     }
                } catch(err) {
                    showNotification('An error occurred while resending the code.');
                }
            });

            // Handle Login
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideNotification();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                try {
                    const response = await fetch('/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showNotification('Login successful!', 'success');
                        window.location.reload();
                    } else {
                         if (data.email_not_verified) {
                            verificationEmail = data.email;
                            document.getElementById('verification-email-display').textContent = verificationEmail;
                            showForm(emailVerificationForm);
                            showNotification('Please verify your email address.', 'warning');
                        } else {
                            showNotification(data.error || 'Login failed.');
                        }
                    }
                } catch (error) {
                    showNotification('An error occurred during login.');
                }
            });


            if (googleLoginBtn) {
                // ... existing google login logic ...
            }
            if (githubLoginBtn) {
                // ... existing github login logic ...
            }
        });
    </script>
</body>
</html>

